<html>
<head>
    <link rel="Stylesheet" type="text/css" href="../../../style.css" />
    <title>ƴӼĵ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<div id="all">
<div id="header">
	<ul id="top-nav">
		<li>
			<a href="../index.html">首页</a>
		</li>
	</ul>
</div>
</div>
    <div class="content">
    
<p>
照片拼接
</p>
<ul>
<li>
获取全景相机的畸变参数

<li>
根据相机的畸变参数计算出映射公式

<li>
输入全景相机拍摄的四张照片并上传至显存

<li>
编写着色器程序生成全景照片的每个像素.

<li>
全景照片中每个像素的值根据映射公式从四张照片中取值.

<li>
计算四张照片所获取的值对全景照片的影响权重, 根据影响权重混合四张照片中的值.

<li>
输出全景照片.
<pre>
((打开程序)) -&gt;&gt; 创建程序窗口, 设置 OpenGL 窗口环境.
创建程序窗口, 设置 OpenGL 窗口环境. -&gt;&gt; 初始化OpenGL运行状态, 分配内存和显存资源, 加载着色器程序
初始化OpenGL运行状态, 分配内存和显存资源, 加载着色器程序 -&gt;&gt; 获取全景相机的畸变参数
获取全景相机的畸变参数 -&gt;&gt; 在显卡内运行着色器程序, 根据畸变参数生成全景图像的映射表
在显卡内运行着色器程序, 根据畸变参数生成全景图像的映射表 -&gt;&gt; 根据映射表计算四个视频对全景图像每个像素的影响权重, 并将其保存为影响权重表
根据映射表计算四个视频对全景图像每个像素的影响权重, 并将其保存为影响权重表 -&gt;&gt; 将生成的影响权重表和映射表上传至显存
将生成的影响权重表和映射表上传至显存 -&gt;&gt; 读取四个输入图像的文件地址, 判断是否有效的图像文件
读取四个输入图像的文件地址, 判断是否有效的图像文件 -&gt;&gt; 上传图像文件的RGB数据至显存内
上传图像文件的RGB数据至显存内 -&gt;&gt; 通过显存内的映射表生成四张全景图像, 每张图像只包含一张源图像的图像内容
通过显存内的映射表生成四张全景图像, 每张图像只包含一张源图像的图像内容 -&gt;&gt; 通过显存内的影响权重表混合四张全景图像得到最终的全景图
通过显存内的影响权重表混合四张全景图像得到最终的全景图 -&gt;&gt; 将图像的内容从显存导出至内存中
将图像的内容从显存导出至内存中 -&gt;&gt; 将内存中的图像数据保存为相应图像格式的文件
将内存中的图像数据保存为相应图像格式的文件 -&gt;&gt; 释放程序运行过程中分配的显存和内存资源
释放程序运行过程中分配的显存和内存资源 -&gt;&gt; ((通知客户拼接结束, 关闭程序窗口))
</pre>

</ul>

<p>
视频拼接
</p>
<ul>
<li>
初始化OpenGL环境, 分配内存和显存资源

<li>
获取全景相机的畸变参数

<li>
根据相机的畸变参数计算出映射公式

<li>
设置输出视频的分辨率, 码率, 帧率, 编码质量信息, 如设置了推流服务则连接服务器.

<li>
读取四个输入视频的文件地址, 判断是否有效的视频文件.

<li>
创建四个线程分别解码四个视频文件

<li>
创建编码线程编码生成的全景视频的图像和声音.

<li>
输入四个视频的同步时间信息, 设置四个视频解码的最初位置.

<li>
逐帧解码视频文件, 分别获取四个视频的图像内容和音频内容

<li>
判断视频是否结束解码, 

<ul>
<li>
如果没有继续进行解码. 

<li>
如果解码已经结束, 终止四个解码线程, 编写全景视频的尾部信息, 最后输出全景视频.

</ul>
<li>
判断解码的内容是图像还是声音

<li>
四个视频文件同时解码出同一时刻的图像内容, 通知拼接模块进行拼接

<ul>
<li>
上传视频文件其图像内容的YUV数据至显存内, 在显存内通过着色器程序直接对YUV数据进行操作.

<li>
计算全景视频的图像内容, 全景视频每个像素的值通过映射公式从四个视频的图像中获取.

<li>
计算出四个视频对全景视频的影响权重, 根据影响权重混合四个视频中的值.

<li>
显存内计算出全景视频图像的内容之后, 将图像内容从显存导出至内存中.

<li>
设置该图像内容的PTS时间信息, 并将其压入待编码的图像队列中.

</ul>
<li>
处理音频内容

<ul>
<li>
解码出第一个视频的音频内容, 并设置该段音频内容的PTS时间信息, 将其压入待编码的音频队列中.

<li>
抛弃其他视频的音频.

</ul>
<li>
全景视频的编码线程不断检测当前待编码的图像队列和音频队列, 如有待编码的图像和音频, 对其进行编码, 将编码后的内容写入文件中, 如设置了推流服务, 同时将编码的内容推流到服务器上. 
<pre>
((打开程序)) -&gt;&gt; 创建程序窗口, 设置 OpenGL 窗口环境.
创建程序窗口, 设置 OpenGL 窗口环境. -&gt;&gt; 初始化OpenGL运行状态, 分配内存和显存资源, 加载着色器程序
初始化OpenGL运行状态, 分配内存和显存资源, 加载着色器程序 -&gt;&gt; 获取全景相机的畸变参数
获取全景相机的畸变参数 -&gt;&gt; 在显卡内运行着色器程序, 根据畸变参数生成全景图像的映射表
在显卡内运行着色器程序, 根据畸变参数生成全景图像的映射表 -&gt;&gt; 根据映射表计算四个视频对全景图像每个像素的影响权重, 并将其保存为影响权重表
根据映射表计算四个视频对全景图像每个像素的影响权重, 并将其保存为影响权重表 -&gt;&gt; 将生成的影响权重表和映射表上传至显存.
将生成的影响权重表和映射表上传至显存. -&gt;&gt; 设置全景输出视频的分辨率, 码率, 帧率, 编码质量
设置全景输出视频的分辨率, 码率, 帧率, 编码质量 -&gt;&gt; 判断输入的推流地址是否有效, 并连接推流服务器
判断输入的推流地址是否有效, 并连接推流服务器 -&gt;&gt; 读取四个输入视频的文件地址, 判断是否有效的视频文件, 并获取视频的解码器, 播放长度, 帧率等信息
读取四个输入视频的文件地址, 判断是否有效的视频文件, 并获取视频的解码器, 播放长度, 帧率等信息 -&gt;&gt; 创建四个解码线程分别解码四个视频文件
创建四个解码线程分别解码四个视频文件 -&gt;&gt; 创建编码线程, 用于编码全景视频的图像和声音
创建编码线程, 用于编码全景视频的图像和声音 -&gt;&gt; 创建两个先进先出队列分别保存待编码的图像和音频数据
创建两个先进先出队列分别保存待编码的图像和音频数据 -&gt;&gt; 输入四个视频的同步时间信息, 设置四个视频解码的最初位置
输入四个视频的同步时间信息, 设置四个视频解码的最初位置 -&gt;&gt; 逐帧解码视频文件, 分别获取四个视频的图像内容和音频内容
逐帧解码视频文件, 分别获取四个视频的图像内容和音频内容 -&gt;&gt; 判断视频是否结束解码?
判断视频是否结束解码? - 没有结束 -&gt;&gt; 如果没有结束则继续进行解码下一帧, 并根据当前帧的时间更新拼接进度
如果没有结束则继续进行解码下一帧, 并根据当前帧的时间更新拼接进度 -&gt;&gt; 判断解码的内容是图像还是声音?
判断解码的内容是图像还是声音? - 声音 -&gt;&gt; 解码出第一个视频的音频内容, 并设置该段音频内容的PTS时间信息, 将其压入待编码的音频队列中
解码出第一个视频的音频内容, 并设置该段音频内容的PTS时间信息, 将其压入待编码的音频队列中 -&gt;&gt; 放弃其他三个视频的音频
判断解码的内容是图像还是声音? - 图像 -&gt;&gt; 上传视频文件其图像内容的YUV数据至显存内, 在显存内通过着色器程序直接对YUV数据转换为RGB数据
上传视频文件其图像内容的YUV数据至显存内, 在显存内通过着色器程序直接对YUV数据转换为RGB数据 -&gt;&gt; 通过显存内的映射表生成四张全景图像, 每张图像只包含一个视频的图像内容
通过显存内的映射表生成四张全景图像, 每张图像只包含一个视频的图像内容 -&gt;&gt; 通过显存内的影响权重表混合四张全景图像得到最终的全景图
通过显存内的影响权重表混合四张全景图像得到最终的全景图 -&gt;&gt; 将最终的全景图从RGB空间转换至YUV空间
将最终的全景图从RGB空间转换至YUV空间 -&gt;&gt; 将图像的内容从显存导出至内存中
将图像的内容从显存导出至内存中 -&gt;&gt; 设置该图像内容的PTS时间信息, 并将其压入待编码的图像队列中
设置该图像内容的PTS时间信息, 并将其压入待编码的图像队列中 -&gt;&gt; 在程序窗口中展示生成的全景图像
在程序窗口中展示生成的全景图像 -&gt;&gt; 编码线程
判断视频是否结束解码? - 结束 -&gt;&gt; 如果四张视频解码已经结束, 关闭四个解码线程
如果四张视频解码已经结束, 关闭四个解码线程 -&gt;&gt; 编码线程编码全景视频的尾部编码信息, 关闭编码线程
编码线程编码全景视频的尾部编码信息, 关闭编码线程 -&gt;&gt; 释放程序运行过程中分配的显存和内存资源, 输出最终生成的全景视频
释放程序运行过程中分配的显存和内存资源, 输出最终生成的全景视频 -&gt;&gt; ((通知客户拼接结束, 关闭程序窗口))
subgraph 编码线程
	编码线程 -&gt;&gt; 调用编码器根据图像的pts时间和图像的YUV数据进行编码, 将生成的编码内容写入输出文件内
	调用编码器根据图像的pts时间和图像的YUV数据进行编码, 将生成的编码内容写入输出文件内 -&gt;&gt; 调用编码器根据声音的pts时间和声音数据进行编码, 将生成的编码内容写入输出文件内
	调用编码器根据声音的pts时间和声音数据进行编码, 将生成的编码内容写入输出文件内 -&gt;&gt; 根据推流设置将全景视频内容发送给推流服务器.
end
</pre>

</ul>


<p>
全景纠错
</p>
<pre>
((打开程序)) -&gt;&gt; 创建程序窗口, 设置 OpenGL 窗口环境.
创建程序窗口, 设置 OpenGL 窗口环境. -&gt;&gt; 初始化OpenGL运行状态, 分配内存和显存资源, 加载着色器程序
初始化OpenGL运行状态, 分配内存和显存资源, 加载着色器程序 -&gt;&gt; 获取全景相机的畸变参数
获取全景相机的畸变参数 -&gt;&gt; 在显卡内运行着色器程序, 根据畸变参数生成全景图像的映射表
在显卡内运行着色器程序, 根据畸变参数生成全景图像的映射表 -&gt;&gt; 根据映射表计算四个视频对全景图像每个像素的影响权重, 并将其保存为影响权重表
根据映射表计算四个视频对全景图像每个像素的影响权重, 并将其保存为影响权重表 -&gt;&gt; 将生成的影响权重表和映射表上传至显存
将生成的影响权重表和映射表上传至显存 -&gt;&gt; 读取四个输入图像的文件地址, 判断是否有效的图像文件
读取四个输入图像的文件地址, 判断是否有效的图像文件 -&gt;&gt; 上传图像文件的RGB数据至显存内
上传图像文件的RGB数据至显存内 -&gt;&gt; 通过显存内的映射表生成四张全景图像, 每张图像只包含一张源图像的图像内容
通过显存内的映射表生成四张全景图像, 每张图像只包含一张源图像的图像内容 -&gt;&gt; 通过显存内的影响权重表混合四张全景图像得到最终的全景图
通过显存内的影响权重表混合四张全景图像得到最终的全景图 -&gt;&gt; 通过球面映射公式在三维场景中的球面上绘制全景图像
通过球面映射公式在三维场景中的球面上绘制全景图像 -&gt;&gt; 客户通过鼠标选择要修正的范围大小和修正位置
客户通过鼠标选择要修正的范围大小和修正位置 -&gt;&gt; 根据要修正的位置判断是哪一张图像受影响
根据要修正的位置判断是哪一张图像受影响 -&gt;&gt; 客户移动鼠标纠错全景图像
客户移动鼠标纠错全景图像 -&gt;&gt; 根据鼠标的移动修改图像在三维场景中球面上的内容 
根据鼠标的移动修改图像在三维场景中球面上的内容 -&gt;&gt; 根据图像在三维场景球面上与鼠标点击位置之间的距离设置图像修改的程度, 距离越远修改程度越小
根据图像在三维场景球面上与鼠标点击位置之间的距离设置图像修改的程度, 距离越远修改程度越小 -&gt;&gt; 客户释放鼠标完成修改, 保存修改后的结果
客户释放鼠标完成修改, 保存修改后的结果 -&gt;&gt; 客户选择撤销, 则取消之前的修改, 将图像恢复到修改之前的状态
客户选择撤销, 则取消之前的修改, 将图像恢复到修改之前的状态 -&gt;&gt; 客户选择重新开始, 则将四张图像恢复到最初的状态
客户选择重新开始, 则将四张图像恢复到最初的状态 -&gt;&gt; 客户选择保存, 将修改后的全景图从显存中导出保存至内存中
客户选择保存, 将修改后的全景图从显存中导出保存至内存中 -&gt;&gt; 将内存中的全景图想数据保存为特定图像格式的图像文件
将内存中的全景图想数据保存为特定图像格式的图像文件 -&gt;&gt; 客户选择下一组的图像进行纠错
客户选择下一组的图像进行纠错 -&gt;&gt; 读取四个输入图像的文件地址, 判断是否有效的图像文件
将内存中的全景图想数据保存为特定图像格式的图像文件 -&gt;&gt; 客户关闭程序
客户关闭程序 -&gt;&gt; 释放程序运行过程中分配的显存和内存资源
释放程序运行过程中分配的显存和内存资源 -&gt;&gt; ((关闭程序窗口))
</pre>

    </div>
</body>
</html>
