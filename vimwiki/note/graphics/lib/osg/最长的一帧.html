<!DOCTYPE html>
<html>
<head>
<link rel="Stylesheet" type="text/css" href="../../../../style.css">
<title>×î³¤µÄÒ»Ö¡</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>

<ul>
<li>
osgViewer/ViewerBase.cpp

<ul>
<li>
ViewerBase::frame(dboule) ä¸»è¦æ‰§è¡Œå†…å®¹å¦‚ä¸‹:

<ol>
<li>
ç¬¬ä¸€å¸§: viewerInit(), realize()

<li>
advance(double)

<li>
eventTraversal()

<li>
updateTraversal()

<li>
renderingTraversals()

</ol>
<li>
viewerInit() è°ƒç”¨ osgViewer::View::init()

<ul>
<li>
_eventQueue å‚¨å­˜è§†æ™¯å™¨çš„äº‹ä»¶é˜Ÿåˆ—

<li>
çª—å£äº‹ä»¶ä½¿ç”¨ osgGA::GUIEventAdapter æ´¾ç”Ÿå¹¶é‡å†™ handler() å‡½æ•°(è§ä¾‹å­ osgkeyboardmouse)

<li>
osgGA::GUIEventAdapter::setEventType è®¾ç½®äº‹ä»¶ç±»å‹ä¸º osgGA::GUIEventAdapter::FRAME, æ¯å¸§éƒ½è°ƒç”¨

<li>
_cameraManipulator å­˜å‚¨ç›¸æœºæ“ä½œå™¨

<ul>
<li>
å¯ç”¨ setCameraManipulator æ¥è®¾ç½®è¿™ä¸ªå˜é‡çš„å†…å®¹

</ul>
<li>
å°†åˆå§‹åŒ–äº‹ä»¶å’Œ Viewer è‡ªèº«ä¼ é€’ç»™ _cameraManipulator çš„ init å‡½æ•°, è¯¥å‡½æ•°å¯ä»¥ç”¨äºåˆå§‹åŒ–å·¥ä½œ. é‡å†™ osgGA::MatrixManipulator::init å¯ä»¥åˆå§‹åŒ–è‡ªå®šä¹‰æ¼«æ¸¸å™¨çš„åŠŸèƒ½.

</ul>
<li>
realize() å®Œæˆçª—å£å’Œåœºæ™¯çš„"è®¾ç½®"å·¥ä½œ

<ul>
<li>
getContexts(contexts) ä½¿ç”¨ osg::GraphicsContext å¯¹è±¡.

<ul>
<li>
osg::GraphicsContext::Traits è®¾ç½®çª—å£å±æ€§.

<li>
åˆ›å»ºçš„ osg::GraphicsContext èµ‹äºˆç»™ç›¸æœº

<li>
getContexts è·å–ä¸»ç›¸æœºå’Œä»å±ç›¸æœºçš„ GraphicsContexts å¹¶ä¿å­˜è‡³ vector

<li>
å‚è€ƒä¾‹å­ osgcamera

</ul>
<li>
å¦‚æœæ²¡æœ‰åˆ›å»º Graphics Context, ç¨‹åºä¼šä¸ºä½ åˆ›å»ºé»˜è®¤ Graphics Context

<ul>
<li>
OSG_CONFIG_FILE é…ç½®æ–‡ä»¶è·¯å¾„

<li>
OSG_WINDOW: çª—å£å¤§å°å’Œå°ºå¯¸, ä½¿ç”¨ osgViewer::View::setUpViewInWindow

<li>
OSG_SCREEN: å±å¹•çª—å£, åˆ›å»ºç›¸åº”æ•°é‡çš„å±å¹•

<li>
osgViewer::View::setUpViewAcrossAllScreens å‡½æ•°, åˆ›å»ºä¸€ä¸ªå…¨å±æ˜¾ç¤ºçš„å›¾å½¢è®¾å¤‡

</ul>
</ul>
<li>
osgViewer::View::setUpViewInWindow: äº”ä¸ªå‚æ•°, çª—å£å·¦ä¸Šè§’x, y, å®½åº¦ width, é«˜åº¦ height, å±å¹•æ•°é‡ screenNum

<ul>
<li>
è·å– osg::DisplaySettings çš„æŒ‡é’ˆ. osg::DisplaySettings ä¿å­˜äº† OSG ç›®å‰ç”¨åˆ°çš„, ä¸å›¾å½¢æ˜¾ç¤º, å°¤å…¶æ˜¯ä¸ç«‹ä½“æ˜¾ç¤ºæœ‰å…³çš„æ‰€æœ‰ä¿¡æ¯.

<li>
osg::DisplaySettings

<ul>
<li>
_displayType: æ˜¾ç¤ºå™¨ç±»å‹. _stereoMode: ç«‹ä½“æ˜¾ç¤ºæ¨¡å¼. _eyeSeparation: åŒçœ¼çš„ç‰©ç†è·ç¦». _screenWidth, _screenHeight: å±å¹•çš„å®é™…å®½åº¦å’Œé«˜åº¦(é»˜è®¤ä¸º0.325, 0.26). _screenDistance: äººçœ¼åˆ°å±å¹•çš„è·ç¦», é»˜è®¤ä¸º0.5.

<li>
_splitStereoHorizontalEyeMapping: å·¦çœ¼æ¸²æŸ“å·¦è§†å£è¿˜æ˜¯å³è§†å£.

<li>
_splitStereoHorizontalSeparation: å·¦è§†å£å’Œå³è§†å£ä¹‹é—´çš„è·ç¦».

<li>
_splitStereoVerticalEyeEyeMapping: å·¦çœ¼æ¸²æŸ“é¡¶è§†å£è¿˜æ˜¯åº•è§†å£.

<li>
_splitStereoVerticalSeparation: é¡¶è§†å£å’Œåº•è§†å£ä¹‹é—´çš„è·ç¦».

<li>
_splitStereoAutoAdjustAspectRatio: é»˜è®¤ä¸º true, ç”¨äºå±å¹•åˆ†å‰²ä¹‹åå¯¹å…¶å®½é«˜æ¯”è¿›è¡Œè¡¥å¿.

<li>
_maxNumOfGraphicsContexts: ç”¨æˆ·ç¨‹åºä¸­æœ€å¤šå¯ç”¨çš„ GraphicsContext æ•°é‡, é»˜è®¤ä¸º 32 ä¸ª.

<li>
_numMultiSamples: å¤šé‡é‡‡æ ·çš„å­åƒç´ æ ·æœ¬æ•°, é»˜è®¤ä¸º 0. å¯ä»¥æ‰“å¼€.

<li>
_minimumNumberStencilBits: æ¨¡æ¿ç¼“å­˜çš„æœ€å°ä½æ•°.

</ul>
<li>
è°ƒç”¨å‡½æ•° ScreenIdentifier::readDISPLAY

<ul>
<li>
æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒå˜é‡ DISPLAY, è°ƒç”¨ ScreenIdentifier::setScreenIdentifier å‡½æ•°, å°†å…¶ä¸­çš„å†…å®¹æŒ‰ç…§"hostName:0.0"çš„æ ¼å¼è§£æä¸ºç³»ç»Ÿçš„ä¸»æœºåå­—(hostName), æ˜¾ç¤ºæ•°(win32ä¸‹å¿…é¡»ä¸º0)å’Œå±å¹•æ¢³(0æˆ–å…¶ä»–æ•°å­—).

</ul>
<li>
ä½¿ç”¨ osg::GraphicsContext::createGraphicsContext() åˆ›å»º gc

<li>
osgGA::GUIEventAdapter::setWindowRectangel è®°å½•æ–°å»ºç«‹çš„çª—å£è®¾å¤‡çš„å¤§å°.

<li>
ä¸»æ‘„åƒæœº _camera çš„é€è§†æŠ•å½±å‚æ•°, å¹¶è®¾ç½®æ–°çš„ Viewport è§†å£.

<li>
osg::Camera::setDrawBuffer å’Œ osgCamera::setReadBuffer: æ‰§è¡Œ glDrawBuffer å’Œ glReadBuffer, è‡ªåŠ¨è®¾ç½®æ­¤æ‘„åƒæœºæƒ³è¦ç»˜åˆ¶å’Œè¯»å–çš„ç¼“å­˜.

<li>
ä¸€äº›è¾…åŠ©å‡½æ•°: getScreenResolution, setScreenResolution, setScreenRefreshRate ç­‰ç›¸å…³å‡½æ•°.

<li>
æ‰§è¡Œ View::assignSceneDataToCameras, åŒ…æ‹¬å¦‚ä¸‹å·¥ä½œ:

<ul>
<li>
å¯¹äºåœºæ™¯æ¼«æ¸¸å™¨, æ‰§è¡Œ setNode å‡½æ•°å’Œ home å‡½æ•°. æ³¨æ„, å¦‚æœæˆ‘ä»¬ä½¿ç”¨ setCameraManipulator å‡½æ•°æ—¶, ä¹Ÿä¼šè‡ªåŠ¨æ‰§è¡ŒåŒæ ·çš„æ“ä½œ.

<li>
å°†åœºæ™¯å›¾èµ‹äºˆä¸»æ‘„åƒæœº _camera, åŒæ—¶è®¾ç½®å®ƒå¯¹åº”çš„æ¸²æŸ“å™¨(Rnerder)çš„ç›¸å…³å‡½æ•°. 
			  åŒæ ·å°†åœºæ™¯å›¾å½¢èµ‹äºˆæ‰€æœ‰çš„ä»æ‘„åƒæœº _slaves, å¹¶è®¾ç½®æ¯ä¸ªä»æ‘„åƒæœºçš„æ¸²æŸ“å™¨.

</ul>
</ul>
<li>
å›åˆ° realize() å‡½æ•°

<ul>
<li>
å¯¹ä¹‹å‰è·å¾—çš„æ‰€æœ‰ gc, ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹ä»£ç 
<pre c++>
gc-&gt;realize();
if(_realizeOperation.valid() &amp;&amp; gc-&gt;valid())
{
	gc-&gt;makeCurrent();
	(*_realizeOperation)(gc);
	gc-&gt;releaseContext();
}
</pre>

<li>
å†æ¬¡éå† GraphicsContext è®¾å¤‡. å¯¹æ¯ä¸ª gc, åˆ¤æ–­å…¶æ˜¯å¦ä¸º GraphicsWindow å¯¹è±¡, æ‰§è¡Œ GraphicsWindow::grabFocusIfPointerInWindow å‡½æ•°(è´Ÿè´£æŠŠé¼ æ ‡ç„¦ç‚¹è½¬åˆ°å½“å‰çª—å£).

<li>
å¯åŠ¨è®¡æ—¶å·¥ä½œ, osg::Timer::setStartTick().

<li>
Viewer::setStartTick(): æ‰¾åˆ°å½“å‰è§†æ™¯å™¨å’Œæ‰€æœ‰ GraphicsContext è®¾å¤‡çš„äº‹ä»¶é˜Ÿåˆ— _eventQueue, å¹¶è®¾å®šä»–ä»¬çš„å¯åŠ¨æ—¶åˆ»ä¸ºå½“å‰æ—¶é—´.

<li>
ViewerBase::setUpThreading: è®¾ç½®çº¿ç¨‹.

</ul>
<li>
osgViewer::ViewerBase::setUpThreading()

<ul>
<li>
osg çš„è§†æ™¯å™¨æœ‰å››ç§çº¿ç¨‹æ¨¡å‹, å¯ä»¥ä½¿ç”¨ setThreadingModel è¿›è¡Œè®¾ç½®.

<ul>
<li>
SingleThreaded: å•çº¿ç¨‹æ¨¡å‹, ä¸ä¼šåˆ›å»ºä»»ä½•æ–°çº¿ç¨‹æ¥å®Œæˆåœºæ™¯çš„ç­›é€‰å’Œæ¸²æŸ“. åœ¨å•æ ¸ä»¥åŠé…ç½®è¾ƒä½çš„ç³»ç»Ÿä¸Šè¿è¡Œç¨³å®š.

<li>
CullDrawThreadPerContext: æ¯ä¸ª GraphicsContext åˆ›å»ºä¸€ä¸ªå›¾å½¢çº¿ç¨‹, å®ç°å¹¶è¡Œçš„æ¸²æŸ“å·¥ä½œ, å°è¯•æŠŠçº¿ç¨‹åˆ†åˆ«æ”¾åœ¨ä¸åŒçš„CPUä¸Šè¿è¡Œ. æ¯ä¸€å¸§ç»“æŸåå¼ºåˆ¶åŒæ­¥æ‰€æœ‰çš„çº¿ç¨‹. åº”ç”¨èŒƒå›´æ¯”è¾ƒæœ‰é™.

<li>
DrawThreadPerContext: ä¸ºæ¯ä¸ª GraphicsContext åˆ›å»ºä¸€ä¸ªå›¾å½¢çº¿ç¨‹, å¹¶åˆ†é…åˆ°ä¸åŒçš„CPUä¸Š, åœ¨å½“å‰å¸§çš„æ‰€æœ‰çº¿ç¨‹å®Œæˆå·¥ä½œä¹‹å‰, å¼€å§‹ä¸‹ä¸€å¸§, å’Œä¸Šé¢ä¸åŒ.

<li>
CullThreadPerCameraDrawTHreadPerContext: ä¸ºæ¯ä¸ª GraphicsContext å’Œæ¯ä¸ªæ‘„åƒæœºåˆ›å»ºçº¿ç¨‹, è¿™ç§æ¨¡å¼åŒæ ·ä¸ä¼šç­‰å¾…å‰ä¸€æ¬¡çš„æ¸²æŸ“ç»“æŸ. å››æ ¸ç”šè‡³æ›´é«˜çš„é…ç½®æ—¶, è¯¥çº¿ç¨‹æ¨¡å‹å°†æœ€å¤§é™åº¦å‘æŒ¥å¤š CPU çš„å¤„ç†èƒ½åŠ›.

</ul>
<li>
æ›´æ–°(Update)å’Œç­›é€‰A(Cull)/ç»˜åˆ¶(Draw)å·¥ä½œæ˜¯ç”± ViewerBase::renderingTraversals å‡½æ•°æ¥å®Œæˆçš„. å¾ˆå¤šçº¿ç¨‹çš„è°ƒåº¦å’ŒåŒæ­¥å·¥ä½œä¹Ÿæ˜¯åœ¨è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆçš„.

<li>
Viewer::getScenes å‡½æ•°è·å–å½“å‰è§†æ™¯å™¨å¯¹åº”çš„ osgViewer::Scene å¯¹è±¡, ä¹Ÿå°±æ˜¯åœºæ™¯. ä¸€ä¸ªåœºæ™¯åŒ…æ‹¬äº†å”¯ä¸€çš„åœºæ™¯å›¾å½¢æ ¹èŠ‚ç‚¹, åˆ†é¡µæ•°æ®åº“(DatabasePager), åˆ†é¡µå›¾åƒåº“(ImagePager). Viewer å¯¹è±¡é€šå¸¸åªåŒ…æ‹¬ä¸€ä¸ª Scene åœºæ™¯, è€Œ COmpositeViewer åˆ™å¯èƒ½åŒ…å«å¤šä¸ªåœºæ™¯å¯¹è±¡.

<li>
ViewerBase::setUpThreading è‡ªåŠ¨æ‰§è¡Œ ViewerBase::startThreading.

</ul>
<li>
realize()

<ul>
<li>
ç¼–è¯‘ä¸Šä¸‹æ–‡(Compile Contexts)
<pre c++>
osg::DisplaySettings::instance()-&gt;setCompileContextsHint(true);
</pre>

<ul>
<li>
éå†æ‰€æœ‰å¯èƒ½çš„ GraphicsContext è®¾å¤‡, é’ˆå¯¹å®ƒä»¬åˆ†åˆ«å†å„è‡ªæ·»åŠ ä¸€ä¸ªæ–°çš„ GraphicsContext è®¾å¤‡, æ‰€ç”¨çš„å‡½æ•°ä¸º GraphicsContext::getOrCreateCompileContext. åœ¨è¿™ä¹‹å, åˆ†åˆ«æ‰§è¡Œäº†åˆ›å»ºå›¾å½¢çº¿ç¨‹, è®¾ç½® CPU ä¾èµ–æ€§, ä»¥åŠå¯åŠ¨å›¾å½¢çº¿ç¨‹çš„å·¥ä½œ.

<li>
getOrCreateComplieContext å‡½æ•°: ä¸»è¦ç”¨äºåˆ›å»ºåå° Graphics Context. è¿™äº›æ–°å¢çš„ GraphicsContext å¯¹è±¡ä½¿ç”¨äº† pBuffer çš„ç‰¹æ€§, å¹¶ä½¿ç”¨å¯¹åº”å¯¹è±¡ç›¸åŒçš„å›¾å½¢ä¸Šä¸‹æ–‡(Traits::sharedContext). ä½¿ç”¨ Pixel BUffer å¯ä»¥æé«˜å›¾å½¢åˆ·æ–°çš„é€Ÿåº¦. è¿˜å¯ä»¥ä¸ºç‰¹å®šçš„ GraphicsContext è®¾å¤‡æ·»åŠ ç‰¹æ®Šçš„å¤„ç†åŠ¨ä½œ.

<ul>
<li>
æ·»åŠ ç‰¹æ®Šå¤„ç†åŠ¨ä½œ: ä½¿ç”¨ osg::GraphicsContext::getCompileContext è·å–åå°å›¾å½¢ä¸Šä¸‹æ–‡, å†ä½¿ç”¨ GraphicsContext::add å‡½æ•°å‘å…¶ä¸­è¿½åŠ  osg::Operation å¯¹è±¡. è§ä¾‹å­ osgterrain.

</ul>
<li>
æ³¨æ„: ç¼–è¯‘ä¸Šä¸‹æ–‡å¯èƒ½åœ¨ Windows ä¸Šçš„å®ç°æœ‰é—®é¢˜.

</ul>
</ul>
</ul>
</ul>


<ul>
<li>
advance å‡½æ•°çš„å·¥ä½œå†…å®¹:

<ul>
<li>
è·å–ä¸Šä¸€æ¬¡è®°å½•çš„å‚è€ƒæ—¶é—´(Reference Time)

<li>
è®¡ç®—å¸§é—´æ—¶é—´

<li>
è®°å½•å·²ç»ç»è¿‡çš„å¸§æ•°

<li>
ViewerBase::getStats è·å– osg::Stats å¯¹è±¡, è¿›è¡Œå¸§çŠ¶æ€çš„ä¿å­˜å’Œæ˜¾ç¤º.

<li>
Referenced::getDeleteHandler() å¤„ç† osg::Referenced å¯¹è±¡è¢«å¼ƒç”¨ä¹‹åçš„åˆ é™¤å·¥ä½œ.

</ul>
<li>
è®°å½•å·¥ä½œ

<ul>
<li>
osg::FrameStamp å˜é‡ _frameStamp å¤„ç†æ€»æ—¶é—´å’Œæ€»å¸§æ•°.

<li>
osg::Stats å˜é‡ _stats è®°å½•å½“å‰å¸§ä»¥åŠä¹‹å‰çš„24å¸§çš„æ¯å¸§ç”¨æ—¶, äº‹ä»¶éå†ç”¨æ—¶, æ›´æ–°éå†ç”¨æ—¶, æ¸²æŸ“éå†ç”¨æ—¶.

<li>
osg::Referenced::getDeleteHnadler()-&gt;flush(): ç»Ÿä¸€åˆ é™¤

<li>
osg::Referenced::getDeleteHnadler()-&gt;setFrameNumber(_frameStamp-&gt;getFrameNUmber())

<li>
DeleteHandler çš„å‚æ•° _numFramesToRetainObjects: åƒåœ¾å¯¹è±¡è¢«æ”¶é›†å, å†ç»è¿‡å¤šå°‘å¸§(é»˜è®¤ä¸º2), æ–¹äºˆä»¥é‡Šæ”¾. ä½¿ç”¨ setFrameNumber è®¾ç½®.

<li>
ç›®å‰ OSG çš„åˆ é™¤ä¸æ˜¯ç”¨åƒåœ¾å›æ”¶, è€Œæ˜¯æ¸²æŸ“ä¹‹å‰æ·»åŠ  ref_ptr å¼•ç”¨è®¡æ•°, æ¸²æŸ“ä¹‹å unref å¼•ç”¨è®¡æ•°, ä½†è¿™æ ·æ¸²æŸ“æ•ˆç‡ä¼šé™ä½ 6%.

<li>
å¦‚æœè¦ä½¿ç”¨ DeleteHandler, å¯ä»¥åŠ å…¥ #undef OSGUTIL_RENDERBACKEND_USE_REF_PTR

</ul>
<li>
osgViewer::Viewer åŒ…æ‹¬å‡ ä¸ªæœ€ä¸»è¦çš„ç»„ä»¶

<ul>
<li>
æ¼«æ¸¸å™¨ _cameraManipulator, ç”¨äºå®ç°äº¤äº’å¼çš„åœºæ™¯æ¼«æ¸¸

<li>
æ—¶é—´å¤„ç†å™¨ç»„ _eventHandlers, è´Ÿè´£å¤„ç† Viewer çš„äº‹ä»¶é˜Ÿåˆ— _eventQueue, ä¸»è¦æ˜¯é”®ç›˜/é¼ æ ‡ç­‰äº‹ä»¶çš„å¤„ç†.

<li>
åœºæ™¯ _scene, åŒ…æ‹¬ Viewer æ‰€å¯¹åº”çš„åœºæ™¯å›¾å½¢æ ¹èŠ‚ç‚¹, ä»¥åŠç”¨äºæé«˜èŠ‚ç‚¹å’Œå›¾åƒæ•°æ®é€Ÿåº¦çš„ä¸¤ä¸ªåˆ†é¡µæ•°æ®åº“.

<li>
æ‘„åƒæœº _camera å’Œ _slaves, å‰è€…ä¸ºåœºæ™¯çš„ä¸»æ‘„åƒæœº, åè€…ä¸ºä»æ‘„åƒæœºç»„.

<ul>
<li>
è§†å£(Viewport)

<li>
å›¾å½¢ä¸Šä¸‹æ–‡ (GraphicsContext), è¡¨ç¤ºå¹³å°ç›¸å…³çš„å›¾å½¢æ˜¾ç¤ºçª—å£(Win32é€šè¿‡CreateWindowExåˆ›å»ºè¯¥çª—å£), æˆ–è€…è¡¨ç¤ºç¦»å±æ¸²æŸ“çš„è®¾å¤‡(PixelBufferWin32).

</ul>
<li>
æ¸²æŸ“å™¨(GraphicsOperation, æ›´å¤šæ—¶å€™æ˜¯ osgViewer::Renderer), è¿™æ˜¯ CULL å’Œ DRAW çš„å…³é”®

<li>
DisplaySettings ç›´æ¥å¯¹æ‘„åƒæœºçš„å¤„ç†å·¥ä½œè´Ÿè´£, å¤§éƒ¨åˆ†è®¾ç½®é€‰é¡¹å¯ä»¥ä¼ é€’åˆ°æ‘„åƒæœºå¯¹åº”çš„çª—å£ç‰¹æ€§(GraphicsContext::Traits)

</ul>
<li>
osgViewer::Viewer::eventTraversal

<ul>
<li>
æ‰§è¡Œç”¨æˆ·è®¾ç½®çš„äº‹ä»¶å›è°ƒ(EventCallback), å¹¶ä¸ºæ‰€æœ‰çš„ç”¨æˆ·äº¤äº’å’Œç³»ç»Ÿäº‹ä»¶æä¾›ä¸€ä¸ªå“åº”çš„æœºåˆ¶.

<li>
_eventHandlers è´Ÿè´£å¤„ç†ç”±å›¾å½¢çª—å£è®¾å¤‡ä¼ é€’åˆ°äº‹ä»¶é˜Ÿåˆ— _eventQueue çš„å„ç§äº‹ä»¶.

<li>
æ–°çš„äº‹ä»¶å¤„ç†å™¨é€šè¿‡ View::addEventHandler æ·»åŠ , é™¤äº† RecordCameraPathHandler å’Œ StatsHandler ç­‰å¸¸è§çš„å¤„ç†å™¨å·¥å…·ä¹‹å¤–, å…¶ä»–çš„è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨éƒ½æ´¾ç”Ÿè‡ª osgGA::GUIEventHandler, å¹¶é‡å†™ handle å‡½æ•°. è§ osgviewer, osgkeyboardmouse ç­‰ä¾‹å­.

<li>
eventTraversal ä¸»è¦ä»»åŠ¡: æ¯ä¸€å¸§è¿‡ç¨‹ä¸­, å–å‡ºå·²ç»å‘ç”Ÿçš„æ‰€æœ‰äº‹ä»¶, ä¸¢å¼ƒå¯¹åœºæ™¯æ— ç›Šçš„(è§†å£ä¹‹å¤–çš„é¼ æ ‡ç‚¹å‡»å’Œä¹±ç‚¹)äº‹ä»¶, ä¾æ¬¡å°†æ‰€æœ‰äº‹ä»¶æäº¤ç»™å„ä¸ªäº‹ä»¶å¤„ç†å™¨, æœ€åæ¸…ç©ºç°æœ‰çš„äº‹ä»¶é˜Ÿåˆ—, ç­‰å¾…ä¸‹ä¸€å¸§.

<li>
è®°å½•äº‹ä»¶éå†çš„æ—¶é—´

<li>
è®°å½•èµ·å§‹æ—¶åˆ»ä¹‹åçš„å·¥ä½œ

<ul>
<li>
å–å‡ºäº‹ä»¶é˜Ÿåˆ—çš„çŠ¶æ€äº‹ä»¶(EventQueue::getCurrentEventState), ä¸ºäº‹ä»¶é˜Ÿåˆ—å…¬ç”¨çš„"çŠ¶æ€äº‹ä»¶"

<li>
å–å‡ºä¸»æ‘„åƒæœºçš„viewportèŒƒå›´, å°†è¯¥èŒƒå›´è®¾ç½®ä¸ºäº‹ä»¶é˜Ÿåˆ—çš„"å“åº”èŒƒå›´"(EventQueue::setInputRange)

<ul>
<li>
EventQueue::setInputRange ä¸»è¦å·¥ä½œè®¾ç½®é¼ æ ‡æ´»åŠ¨çš„æœ€å¤§å’Œæœ€å°èŒƒå›´

<li>
EventQueue::setUseFIxedMouseInputRange: å¼€å¯äº†é¼ æ ‡èŒƒå›´çš„é™å®šæ ‡å¿—, é¼ æ ‡ç§»åŠ¨çš„èŒƒå›´è‡ªåŠ¨é™åˆ¶åœ¨è¿™ä¸ªèŒƒå›´ä¹‹å†…(é»˜è®¤å…³é—­)

</ul>
<li>
è®¡ç®—ä¸»æ‘„åƒæœºçš„ VPW çŸ©é˜µ

</ul>
<li>
é€šè¿‡ Viewer::getContexts å‡½æ•°æ‰¾åˆ° Viewer ä¸­æ‰€æœ‰å·²æœ‰çš„ GraphicsWindow å›¾å½¢çª—å£, ç„¶åæ‰§è¡Œ GraphicsWindowWin32::checkEvents å‡½æ•°.

<ul>
<li>
é€šçŸ¥ Windows æ‰§è¡Œçª—å£çš„æ¶ˆæ¯å›è°ƒå‡½æ•°, è¿›è€Œæ‰§è¡Œç”¨æˆ·äº¤äº’å’Œç³»ç»Ÿæ¶ˆæ¯çš„æ£€æŸ¥å‡½æ•° GraphicsWindowWin32::handleNativeWindowingEvent.

<li>
GraphicsWindowWin32::handleNativeWindowingEvent çš„ä½œç”¨è´Ÿè´£æŠŠ WM_* æ¶ˆæ¯è½¬åŒ–å¹¶ä¼ é€’ç»™ osgGA::EventQueue æ¶ˆæ¯é˜Ÿåˆ—

</ul>
<li>
ä½¿ç”¨ EventQueue::takeEvents å‡½æ•°, æŠŠå½“å‰ GraphicsWindow å›¾å½¢çª—å£å¯¹è±¡ gw çš„äº‹ä»¶é˜Ÿåˆ—ä¿å­˜åˆ°æŒ‡å®šçš„å˜é‡ gw_events ä¸­.
<pre c++>
osgGA::EventQueue::Events gw_events;
gw-&gt;getEventQueue()-&gt;takeEvents(gw_events);
</pre>

<li>
ç¬¦åˆä¸‹åˆ—æ¡ä»¶çš„æ‘„åƒæœº, ä¸º"ç„¦ç‚¹æ‘„åƒæœº"(_cameraWithFocus)

<ul>
<li>
é¼ æ ‡ç§»åŠ¨æ—¶, é¼ æ ‡è¿›å…¥äº†æ‘„åƒæœºçš„è§†å£èŒƒå›´ä¹‹å†…

<li>
æ‘„åƒæœºæ˜¯å¯¹åº”è¯¥è§†å£çš„, å…è®¸æ¥æ”¶äº‹ä»¶(Camera::getAllowEventFocus), ä¸”"æ¸²æŸ“ç›®æ ‡å®ç°æ–¹å¼"(Render Target Implementaton) ä¸º Camera::FRAME_BUFFER

</ul>
<li>
å°†ç„¦ç‚¹æ‘„åƒæœºçš„åæ ‡è½¬æ¢ä¸ºä¸»æ‘„åƒæœºçš„äºŒç»´åæ ‡. é€šè¿‡ä¸¤è€…çš„ VPW å®ç°.
<pre c++>
osg::Viewport* viewport = getCameraWithFocus()-&gt;getViewport(); 
osg::Matrix localCameraVPW = getCameraWithFocus()-&gt;getViewMatrix() *   
    getCameraWithFocus()-&gt;getProjectionMatrix(); 
if (viewport) localCameraVPW *= viewport-&gt;computeWindowMatrix(); 
osg::Matrix matrix( osg::Matrix::inverse(localCameraVPW) * masterCameraVPW ); 
osg::Vec3d new_coord = osg::Vec3d(x,y,0.0) * matrix; 
x = new_coord.x(); 
y = new_coord.y(); 
â€¦â€¦ 
</pre>

<li>
å•ä¸€çª—å£çš„å…³é—­å·¥ä½œ
<pre c++>
bool wasThreading = areThreadsRunning(); 
if (wasThreading) stopThreading(); 
gw-&gt;close(); 
if (wasThreading) startThreading(); 
</pre>

<ul>
<li>
é¦–å…ˆå°è¯•ç»ˆæ­¢æ‰€æœ‰çš„æ¸²æŸ“çº¿ç¨‹(åŒ…æ‹¬å„ä¸ªå›¾å½¢è®¾å¤‡å¼€å¯çš„çº¿ç¨‹å’Œæ¸²æŸ“å™¨å¼€å¯çš„çº¿ç¨‹), å…³é—­çª—å£åå†æ‰“å¼€æ‰€æœ‰çš„æ¸²æŸ“çº¿ç¨‹.

<li>
å½“æˆ‘ä»¬è¯•å›¾åœ¨è¿è¡Œæ—¶å¼€å¯ä¸€ä¸ªæ–°çš„ OSG å›¾å½¢çª—å£æ—¶, ä¹Ÿå¿…é¡»ä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹æ§åˆ¶æ­¥éª¤. å…³é—­çº¿ç¨‹, åˆ›å»ºæ–°æ¸²æŸ“çª—å£, å¼€å¯çº¿ç¨‹.

</ul>
<li>
æ‰€æœ‰æ¥è‡ªå›¾å½¢çª—å£å’ŒViewerçš„äº‹ä»¶éƒ½è¢«æ·»åŠ åˆ°ä¸€ä¸ª std::list é“¾è¡¨ä¸­.

<li>
OSG çš„æ¨å‡ºäº‹ä»¶

<ul>
<li>
é€€å‡ºé”® Esc

<li>
ViewerBase::setQuitEventSetsDone è®¾ç½®æ˜¯å¦å…è®¸æŒ‰ä¸‹æŸä¸ªé”®ä¹‹åç›´æ¥é€€å‡º. é»˜è®¤ä¸º GUIEventAdapter::Key_Escape.

<li>
ViewerBase::setDone å‡½æ•°å¸®åŠ©æˆ‘ä»¬éšæ—¶ç»“æŸä»¿çœŸç¨‹åº.

</ul>
<li>
éå†äº‹ä»¶, æ¯ä¸ª GUIEventAdapter äº‹ä»¶ event ä¼ é€’ç»™æ¯ä¸€ä¸ªæ³¨å†Œçš„ GUIEventHandler äº‹ä»¶å¤„ç†å™¨.
<pre c++>
for(EventHandlers::iterator hitr = _eventHandlers.begin(); 
        hitr != _eventHandlers.end(); 
        ++hitr) 
{ 
    (*hitr)-&gt;handleWithCheckAgainstIgnoreHandledEventsMask( *event, *this, 0, 0); 
} 
</pre>

<ul>
<li>
osgGA::GUIEventHandler::handleWithCheckAgainstIgnoreHandledEventsMask()

<ul>
<li>
ä¸»è¦å·¥ä½œæ˜¯æ‰§è¡Œ GUIEventHandlere::handle å‡½æ•°.

<li>
è¯¥å‡½æ•°ä¸è¦å»é‡å†™

</ul>
<li>
GUIEventHandler::setIgnoreHandledEventsMask å‡½æ•°, å¸Œæœ›æŸä¸ªäº‹ä»¶å¤„ç†å™¨æš‚æ—¶ä¸è¦å¤„ç†æŸä¸€äº‹ä»¶. é€šè¿‡ GUIEventAdapter::EventType ç±»å‹çš„å‚æ•°å®ç°.

</ul>
<li>
éå†äº‹ä»¶, æ¯ä¸ª GUIEventAdapter äº‹ä»¶ event ä¼ é€’ç»™ _cameraManipulator

<li>
æ‰§è¡Œæ¯ä¸ªèŠ‚ç‚¹å’ŒDrawableçš„äº‹ä»¶å›è°ƒå‡½æ•°

<ul>
<li>
å¯¹äºä»»æ„èŠ‚ç‚¹, Geode å¶èŠ‚ç‚¹ä»¥åŠä»»æ„ Drawable å‡ ä½•ä½“, æˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨ setEventCallback å’Œ setUpdateCallback å‡½æ•°è®¾ç½®å®ƒçš„äº‹ä»¶å›è°ƒå’Œæ›´æ–°å›è°ƒå¯¹è±¡. è¿™äº›å›è°ƒå‡½æ•°åœ¨ eventTraversal å‡½æ•°ä¸­å¤„ç†

<ul>
<li>
èŠ‚ç‚¹çš„å›è°ƒå¯¹è±¡å¿…é¡»ä¸º osg::NodeCallback ä»¥åŠ NodeCallback::operator() å‡½æ•°, Drawable å¯¹è±¡çš„äº‹ä»¶å›è°ƒå¯¹è±¡ä¸º Drawable::EventCallback ä»¥åŠ EventCallback::event() å‡½æ•°, Drawable å¯¹è±¡çš„æ›´æ–°å›è°ƒå¯¹è±¡ä¸º Drawable::UpdateCallback ä»¥åŠ UpdateCallback::update å‡½æ•°.

<li>
_eventVisitor è´Ÿè´£ç®¡ç†äº‹ä»¶å›è°ƒçš„éå†å·¥ä½œ. _updateVisitor è´Ÿè´£æ›´æ–°éå†. è¿˜å¯ä»¥ä½¿ç”¨ ViewerBase::setEventVisitor åŠ è½½æˆ‘ä»¬è‡ªå®šä¹‰çš„äº‹ä»¶è®¿é—®å™¨

</ul>
</ul>
<li>
æ‰§è¡Œæ¯ä¸ªç›¸æœºå’Œä»å±ç›¸æœºçš„äº‹ä»¶å›è°ƒå‡½æ•°, ä½¿ç”¨äº‹ä»¶è®¿é—®å™¨æ—¶æ³¨æ„å…³é—­è®¿é—®å™¨çš„éå†
<pre c++>
osg::NodeVisitor::TraversalMode tm = _eventVisitor-&gt;getTraversalMode(); 
_eventVisitor-&gt;setTraversalMode(osg::NodeVisitor::TRAVERSE_NONE); 
if (_camera.valid() &amp;&amp; _camera-&gt;getEventCallback()) _camera-&gt;accept(*_eventVisitor); 
for(unsigned int i=0; i&lt;getNumSlaves(); ++i) 
{ 
    osg::Camera* camera = getSlave(i)._camera.get(); 
    if (camera &amp;&amp; camera-&gt;getEventCallback()) camera-&gt;accept(*_eventVisitor); 
} 
_eventVisitor-&gt;setTraversalMode(tm); 
</pre>

</ul>
<li>
osgViewer::Viewer::updateTraversal()

<ul>
<li>
æ›´æ–°å›è°ƒä½¿ç”¨ _updateVisitor è¿›è¡Œåœºæ™¯å›¾å½¢æ›´æ–°éå†. é€šè¿‡ setUpdateCallback è®¾ç½®æ›´æ–°å›è°ƒ.

<li>
äº‹ä»¶å›è°ƒå’Œæ›´æ–°å›è°ƒçš„åŒºåˆ«: æ¯ä¸ªäº‹ä»¶éƒ½ä¼šè°ƒç”¨äº‹ä»¶å›è°ƒä¸€æ¬¡, æ›´æ–°å›è°ƒåªåœ¨æ¯å¸§è°ƒç”¨ä¸€æ¬¡.

<li>
updateTraversal çš„ä½œç”¨: å¤„ç†ç”¨æˆ·çš„æ›´æ–°å›è°ƒå¯¹è±¡, æ›´æ–°æ‘„åƒæœºçš„ä½ç½®, æ›´æ–°åˆ†é¡µæ•°æ®åº“ DatabasePager å’Œå›¾åƒåº“ ImagePager çš„å†…å®¹. ä¸»è¦æµç¨‹å¦‚ä¸‹:

<ul>
<li>
è·å–å‡½æ•°çš„èµ·å§‹æ—¶åˆ»

<li>
_updateVisitor è®¿é—®åœºæ™¯å›¾å½¢çš„æ ¹èŠ‚ç‚¹å¹¶éå†å…¶å­èŠ‚ç‚¹. å®ç°å„ä¸ªèŠ‚ç‚¹å’Œ Drawable å¯¹è±¡çš„æ›´æ–°å›è°ƒ.

<li>
DatabasePager::updateSceneGraph ä»¥åŠ ImagePager::updateSceneGraph æ›´æ–°åœºæ™¯çš„åˆ†é¡µæ•°æ®åº“å’Œåˆ†é¡µå›¾åƒåº“

<li>
å¤„ç†ç”¨æˆ·å®šä¹‰çš„æ›´æ–°å·¥ä½œé˜Ÿåˆ— _updateOperations.

<li>
ä¸»æ‘„åƒæœº _camera ä»¥åŠä»æ‘„åƒæœº _slaves çš„æ›´æ–°å›è°ƒ(æ³¨æ„åˆ«éå†å®ƒä»¬çš„å­èŠ‚ç‚¹)

<li>
æ ¹æ®_cameraManipulator çš„ä½ç½®å§¿æ€çŸ©é˜µå»æ›´æ–°ä¸»æ‘„åƒæœºçš„ _camera çš„è§‚å¯ŸçŸ©é˜µ. MatrixManipulator::getInverseMatrix.

<li>
View::updateSlaves æ›´æ–°æ‰€æœ‰ _slaves ä¸­æ‰€æœ‰æ‘„åƒæœºçš„æŠ•å½±çŸ©é˜µ, è§‚å¯ŸçŸ©é˜µä»¥åŠåœºæ™¯ç­›é€‰è®¾ç½®(CullSetting)

<li>
è·å–å‡½æ•°çš„ç»“æŸæ—¶åˆ», å°†ç›¸å…³çš„æ—¶åˆ»ä¿¡æ¯ä¿å­˜åˆ°è®°å½•å™¨ä¸­.

</ul>
<li>
ä¹‹å‰ ViewerBase::setRealizeOperation è¿›è¡Œè‡ªå®šä¹‰çš„åœºæ™¯é¢„å¤„ç†å·¥ä½œ. è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ _updateOperations æ›´æ–°å·¥ä½œé˜Ÿåˆ—è¿›è¡Œè‡ªå®šä¹‰çš„åœºæ™¯æ›´æ–°å·¥ä½œ, é€šè¿‡å‡½æ•° ViewerBase::addUpdateOperation å†™å…¥å¤šç»„æ›´æ–°å¤„ç†å™¨ Operation å¯¹è±¡(æˆ–è€…ä½¿ç”¨å¯¹åº”çš„æˆå‘˜å‡½æ•° removeUpdateOperation æ¥ç§»é™¤), å› æ­¤å¯ä»¥å®ç°çš„æ“ä½œä¹Ÿæ›´ä¸°å¯Œ.

<ul>
<li>
ä¹ æƒ¯ä¸Š Operation å¯¹è±¡å¯ä»¥ç”¨æ¥å¤„ç†ä¸å›¾å½¢è®¾å¤‡ä»¥åŠ OpenGL åº•å±‚ API ç›¸å…³çš„å·¥ä½œ, ä¸è¿‡ç”¨æˆ·å±‚çº§çš„å·¥ä½œåœ¨è¿™é‡Œå®ç°é€šå¸¸ä¹Ÿæ²¡æœ‰é—®é¢˜

</ul>
<li>
osgViewer::View::updateSlave()

<ul>
<li>
æ›´æ–°ä»å±æ‘„åƒæœºç»„ _slaves:

<ul>
<li>
ä»å±æ‘„åƒæœºç»§æ‰¿äº†ä¸»æ‘„åƒæœºçš„æŠ•å½±çŸ©é˜µ, è§‚å¯ŸçŸ©é˜µå’Œåœºæ™¯ç­›é€‰è®¾ç½®. ä½†å¯ä»¥åœ¨ View::addSlave æ·»åŠ ä»å±æ‘„åƒæœºæ—¶, è®¾ç½®æŠ•å½±çŸ©é˜µä¸è§‚å¯ŸçŸ©é˜µçš„åç½®å€¼, è¿˜å¯ä»¥ä½¿ç”¨ CullSettings::setInheritanceMask è®¾ç½® CullSettings çš„ç»§æ‰¿æ©ç 

<li>
osg::Camera ç±»ç»§æ‰¿è‡ª osg::CullSettings ç±», æœ‰å‡ ç§ç­›é€‰:

<ul>
<li>
èƒŒé¢ç­›é€‰: GL_CULLFACE

<li>
è§†é”¥ä½“ç­›é€‰: view frustum culling

<li>
å‰ªåˆ‡å¹³é¢ç­›é€‰: clip plane

<li>
é®æŒ¡ç­›é€‰: occlusion culling, ä¼šå¢å¤§è®¡ç®—çš„å¼€é”€, ä»…ä½œä¸ºä¸€ä¸ªé¢„å¤„ç†æ­¥éª¤å‡ºç°

</ul>
<li>
OSG æ”¯æŒçš„åœºæ™¯ç­›é€‰æ–¹å¼

<ul>
<li>
NO_CULLING: ä¸è¿›è¡Œåœºæ™¯ç­›é€‰å·¥ä½œ

<li>
NEAR_PLANE_CULLING: è¿‘å¹³é¢ç­›é€‰, å°†è¶…å‡ºè¿‘å¹³é¢èŒƒå›´ä¹‹å¤–çš„å¯¹è±¡å‰”é™¤

<li>
FAR_PLANE_CULLING: è¿œå¹³é¢ç­›é€‰, å°†è¶…å‡ºå¹³é¢èŒƒå›´ä¹‹å¤–çš„å¯¹è±¡å‰”é™¤

<li>
VIEW_FRUSTUM_CULLING: è§†é”¥ä½“ç­›é€‰, ä¿è¯åœºæ™¯ä¸­åªæœ‰è§†é”¥ä½“èŒƒå›´å†…çš„ä¸€å°éƒ¨åˆ†èŠ‚ç‚¹å’ŒDrawableæ˜¯å¯è§çš„, å› è€ŒåŠ é€Ÿåœºæ™¯çš„ç»˜åˆ¶é€Ÿåº¦.

<li>
VIEW_FRUSTUM_SIDES_CULLING: è§†é”¥ä½“ä¾§é¢ç­›é€‰, å®ƒä¸æ‰§è¡Œè¿‘å¹³é¢/è¿œå¹³é¢çš„ç­›é€‰å·¥ä½œ, é™¤æ­¤ä¹‹å¤–ä¸VIEW_FRUSTUM_CULLINGæ²¡æœ‰åŒºåˆ«

<li>
SMALL_FEATURE_CULLING: ç»†èŠ‚ç­›é€‰, ç­›é€‰æ‰ç»†å¾®ç‰©ä½“. CullSettings::setSmallFeatureCullingPixelsSize è®¾ç½®ç»†å¾®ç‰©ä½“çš„é˜€å€¼

<li>
SHADOW_OCCLUSION_CULLING: é®æŒ¡ç­›é€‰, è§ä¾‹å­ osgoccluder

<li>
CLUSTER_CULLING: èšé›†ç­›é€‰, ç±»ä¼¼äºèƒŒé¢ç­›é€‰, å°†å¤šä¸ªå¯¹è±¡ç»„åˆèµ·æ¥å¹¶è¿›è¡Œç»Ÿä¸€çš„èƒŒé¢ç­›é€‰, OSG å¯ä»¥ä½¿ç”¨ç­›é€‰å›è°ƒ ClusterCullingCallback æ¥å®ç°èŠ‚ç‚¹çš„èšé›†ç­›é€‰(å¯¹èŠ‚ç‚¹ä½¿ç”¨ Node::setCullback). å¯¹äºåœ°çƒåœ°ç†ä¿¡æ¯çš„è£å‰ªæ—¶å¾ˆé€‚ç”¨

<li>
DEFAULT_CULLING: é»˜è®¤æƒ…å†µæ‰“å¼€è§†é”¥ä½“ä¾§é¢ç­›é€‰, ç»†èŠ‚ç­›é€‰, é®æŒ¡ç­›é€‰å’Œèšé›†ç­›é€‰çš„é€‰é¡¹

<li>
ENABLE_ALL_CULLING: å¼€å¯å…¨éƒ¨ç­›é€‰æ–¹å¼.

</ul>
<li>
CullSettings::setCullingMode è®¾ç½®ä¸€ç§æˆ–å¤šç§ç­›é€‰æ–¹å¼. å¦‚æš‚æ—¶å±è”½ä¸€ç§ç­›é€‰æ–¹å¼
<pre c++>
camera-&gt;setCullingMode(camera-&gt;getCullingMode() &amp; 
    ~osg::CullSettings::SMALL_FEATURE_CULLING); 
</pre>

<li>
æœ‰å…³å„ç§ç­›é€‰æ–¹å¼çš„è¯¦ç»†ç®—æ³•ï¼Œå¯ä»¥å‚è€ƒ CullingSet::isCulled å‡½æ•°ï¼Œæœ‰å…³é®æŒ¡ç­›é€‰å’Œèšé›†ç­›é€‰çš„ç®—æ³•è¯·å•ç‹¬å‚é˜… OccluderNodeï¼ŒConvexPlanarOccluder å’Œ ClusterCullingCallback ç­‰ç›¸å…³ç±»çš„å®ç°ä»£ç ã€‚

</ul>
</ul>
</ul>
</ul>

</body>
</html>
